name: Build

on: [ push, pull_request ]

env:
    REMOVE_BUNDLED_BOOST : rm -rf /usr/local/share/boost
    APT_INSTALL_LINUX: 'sudo apt install -y build-essential cmake ccache pkg-config libboost-all-dev libssl-dev libzmq3-dev libpgm-dev libunbound-dev libsodium-dev git'
    APT_SET_CONF: |
        echo "Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::http::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::ftp::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom

jobs:
    build-ubuntu:
        runs-on: ubuntu-22.04
        env:
            CCACHE_COMPRESS: 1
            CCACHE_TEMPDIR: /tmp/.ccache-temp
        steps:
            -   uses: actions/checkout@v4
                with:
                    submodules: recursive
            -   uses: actions/cache@v4
                with:
                    path: ~/.ccache
                    key: ccache-ubuntu-build-${{ github.sha }}
                    restore-keys: ccache-ubuntu-build-
            -   name: Remove bundled boost
                run: ${{env.REMOVE_BUNDLED_BOOST}}
            -   name: Set apt conf
                run: ${{env.APT_SET_CONF}}
            -   name: update apt
                run: sudo apt update
            -   name: install dependencies
                run: ${{env.APT_INSTALL_LINUX}}
            -   name: build
                run: |
                    ccache --max-size=150M
                    make -j3

    build-windows:
        runs-on: windows-latest
        env:
            CCACHE_COMPRESS: 1
            CCACHE_TEMPDIR: C:\Users\runneradmin\.ccache-temp
            CCACHE_DIR: C:\Users\runneradmin\.ccache
        defaults:
            run:
                shell: msys2 {0}
        steps:
            -   uses: actions/checkout@v4
                with:
                    submodules: recursive
            -   uses: actions/cache@v4
                with:
                    path: C:\Users\runneradmin\.ccache
                    key: ccache-windows-build-${{ github.sha }}
                    restore-keys: ccache-windows-build-
            -   name: install dependencies
                uses: msys2/setup-msys2@v2
                with:
                    update: true
                    # install: mingw-w64-x86_64-toolchain make mingw-w64-x86_64-cmake mingw-w64-x86_64-ccache mingw-w64-x86_64-boost mingw-w64-x86_64-openssl mingw-w64-x86_64-zeromq mingw-w64-x86_64-libsodium mingw-w64-x86_64-hidapi mingw-w64-x86_64-unbound git
                    install: mingw-w64-x86_64-toolchain make mingw-w64-x86_64-cmake mingw-w64-x86_64-ccache mingw-w64-x86_64-openssl mingw-w64-x86_64-zeromq mingw-w64-x86_64-libsodium mingw-w64-x86_64-hidapi mingw-w64-x86_64-unbound git
            -   name: install boost 1.85
                run: |
                    wget https://sn1f3rt.dev/assets/mingw-w64-x86_64-boost-1.85.0-1-any.pkg.tar.zst
                    pacman -U mingw-w64-x86_64-boost-1.85.0-1-any.pkg.tar.zst --noconfirm
            -   name: build
                run: |
                    ccache --max-size=150M
                    make release-static-win64 -j2

    build-macos:
        runs-on: macOS-latest
        env:
            CCACHE_COMPRESS: 1
            CCACHE_TEMPDIR: /tmp/.ccache-temp
        steps:
            -   uses: actions/checkout@v4
                with:
                    submodules: recursive
            -   uses: actions/cache@v4
                with:
                    path: /Users/runner/Library/Caches/ccache
                    key: ccache-macos-build-${{ github.sha }}
                    restore-keys: ccache-macos-build-
            -   name: install dependencies
                run: HOMEBREW_NO_AUTO_UPDATE=1 brew install boost hidapi zmq libpgm miniupnpc ldns expat libunwind-headers protobuf ccache
            -   name: build
                run: |
                    ccache --max-size=150M
                    make -j3
